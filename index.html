<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mesin Prompt â€” Veo3 (Hiburan & Afiliasi)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0f19;--panel:#12172a;--muted:#aab3c8;--text:#e8eeff;--acc:#7aa2ff;--line:#22305a}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.6 Inter,system-ui}
    .card{background:linear-gradient(180deg,#12172a,#0f1430 70%);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 26px rgba(0,0,0,.25)}
    .pill{background:#0e1633;border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .input,textarea,select{background:#0c1227;border:1px solid var(--line);border-radius:10px;padding:10px 12px;color:var(--text);width:100%}
    textarea{min-height:88px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;border-radius:12px;padding:10px 14px;font-weight:800}
    .btn-primary{background:var(--acc);color:#061434}
    .btn-ghost{background:#0c1227;border:1px solid var(--line);color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .muted{color:var(--muted)} .hr{height:1px;background:var(--line)}
    .kbd{font-family:ui-monospace,Consolas,monospace;background:#0e1630;border:1px solid var(--line);padding:1px 6px;border-radius:6px}
    .link{color:#9ec1ff;text-decoration:underline}
  </style>
</head>
<body>
  <main class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="mb-5">
      <h1 class="text-2xl sm:text-3xl font-extrabold">Mesin Prompt JSON â€” Veo3</h1>
      <p class="muted">Dua mode: <b>Hiburan</b> (cerita) & <b>Afiliasi</b> (iklan 8 detik). Output: JSON siap pakai.</p>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- FORM -->
      <div class="card p-4 lg:col-span-1">
        <div class="flex items-center gap-2 mb-3">
          <span class="pill">Mode</span>
          <select id="mode" class="input w-auto">
            <option value="hiburan">Hiburan (Cerita)</option>
            <option value="afiliasi">Afiliasi (Iklan 8s)</option>
          </select>
        </div>

        <!-- HIBURAN -->
        <div id="hiburanFields" class="space-y-3">
          <div>
            <label class="muted text-sm">Ide Karakter / Tokoh</label>
            <textarea id="charIdea" class="input" placeholder="Contoh: teknisi wanita 20-an, rambut pendek, sinis tapi lembut pada hewan"></textarea>
          </div>
          <div>
            <label class="muted text-sm">Premis Cerita</label>
            <textarea id="premis" class="input" placeholder="Contoh: menemukan portal mini di laci meja, membawa pulang kucing dari dimensi lain"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="muted text-sm">Gaya Visual</label>
              <select id="visual" class="input">
                <option>Live-Action - Sinematik Realistis</option>
                <option>Live-Action - Dokumenter (Handheld)</option>
                <option>Anime - Modern (Hibrida 2.5D)</option>
                <option>3D - Hiper-realistis (Unreal Engine)</option>
              </select>
            </div>
            <div>
              <label class="muted text-sm">Bahasa Audio</label>
              <select id="lang" class="input">
                <option>id-ID</option><option>en-US</option>
              </select>
            </div>
          </div>
          <div>
            <label class="muted text-sm">(Opsional) Arahan Cerita</label>
            <input id="arah" class="input" placeholder="Contoh: akhir open ending, tone bittersweet"/>
          </div>
        </div>

        <!-- AFILIASI -->
        <div id="afiliasiFields" class="hidden space-y-3">
          <div>
            <label class="muted text-sm">Nama Produk / Merek</label>
            <input id="brand" class="input" placeholder="Contoh: Zenoora"/>
          </div>
          <div>
            <label class="muted text-sm">Premis Video (8 detik)</label>
            <textarea id="premisAd" class="input" placeholder="Contoh: transisi objek biasa â†’ versi aesthetic, close-up detail, senyum di akhir"></textarea>
          </div>
          <div>
            <label class="muted text-sm">2â€“3 Kelebihan Utama (pisah koma / baris)</label>
            <textarea id="benefit" class="input" placeholder="bahan nyaman, desain minimal, muat banyak"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="muted text-sm">CTA</label>
              <input id="cta" class="input" value="KLIK KERANJANG KUNING / BELI SEKARANG"/>
            </div>
            <div>
              <label class="muted text-sm">Bahasa Audio</label>
              <select id="langAd" class="input">
                <option>id-ID</option><option>en-US</option>
              </select>
            </div>
          </div>
          <p class="muted text-xs">Guard: tanpa logo, harga, klaim kesehatan berlebihâ€”akan diset otomatis di JSON.</p>
        </div>

        <div class="my-4 hr"></div>

        <div class="flex gap-2 flex-wrap">
          <button id="genBtn" class="btn btn-primary">âš¡ Hasilkan Prompt JSON</button>
          <button id="copyBtn" class="btn btn-ghost">ðŸ“‹ Salin JSON</button>
        </div>

        <details class="mt-4">
          <summary class="cursor-pointer muted">Opsional: AI Assist (tanpa Google Cloud)</summary>
          <div class="mt-3 space-y-2">
            <label class="muted text-sm">OpenRouter API Key (opsional)</label>
            <input id="orKey" class="input" placeholder="sk-or-... (jika diisi, tombol AI aktif)"/>
            <div class="flex gap-2">
              <button id="assistScenes" class="btn btn-ghost">âœ¨ AI Assist: Isi 3 Scene</button>
              <button id="assistCopy" class="btn btn-ghost">ðŸ§ª AI Perbaiki VO</button>
            </div>
            <p class="muted text-xs">Jika kosong, mesin tetap bekerja offline. Daftar gratis: <a class="link" href="https://openrouter.ai" target="_blank" rel="noopener">openrouter.ai</a></p>
          </div>
        </details>
      </div>

      <!-- OUTPUT -->
      <div class="card p-4 lg:col-span-2">
        <label class="muted text-sm mb-1 block">Output Prompt (JSON)</label>
        <textarea id="output" class="input mono min-h-[420px]" spellcheck="false" placeholder="Hasil prompt akan muncul di sini..."></textarea>
        <p class="muted text-xs mt-2">Struktur: <span class="kbd">engine</span>, <span class="kbd">global</span>, <span class="kbd">script/characters</span>, <span class="kbd">scenes[3]</span>. Shortcut: <span class="kbd">Ctrl/Cmd</span> + <span class="kbd">Enter</span> = Generate.</p>
      </div>
    </section>
  </main>

  <script>
    // ===== UTIL =====
    const el = id => document.getElementById(id);
    const sanitize = s => (s||'').toString().trim();

    // JSON cleaners & strict system prompt
    function cleanToJSON(text){
      if(!text) return null;
      let t = String(text).replace(/```json|```/gi,'').trim();
      const first = Math.min(...['{','['].map(ch => {const i=t.indexOf(ch); return i<0?1e9:i;}));
      const last  = Math.max(t.lastIndexOf('}'), t.lastIndexOf(']'));
      if(last < first || first===1e9) return null;
      const slice = t.slice(first, last+1).trim();
      try { return JSON.parse(slice); } catch(e){}
      const safe = slice.replace(/,\s*([}\]])/g,'$1').replace(/[\u0000-\u001F]/g,'');
      try { return JSON.parse(safe); } catch(e){ return null; }
    }
    function forceJSONSystem(schemaHint){
      return "Kamu adalah formatter. Jawab HANYA dalam JSON valid tanpa teks lain. " + (schemaHint?("Skema: "+schemaHint):"");
    }

    // ===== MODE TOGGLE =====
    const modeEl = el('mode'), out = el('output');
    const hiburanFields = el('hiburanFields');
    const afiliasiFields = el('afiliasiFields');
    modeEl.addEventListener('change', () => {
      const ad = modeEl.value === 'afiliasi';
      hiburanFields.classList.toggle('hidden', ad);
      afiliasiFields.classList.toggle('hidden', !ad);
      out.value = '';
    });
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key === 'Enter'){ el('genBtn').click(); }
    });

    // ===== BUILDERS =====
    function buildHiburan(){
      const charIdea = sanitize(el('charIdea').value);
      const premis   = sanitize(el('premis').value);
      const visual   = sanitize(el('visual').value);
      const lang     = sanitize(el('lang').value || 'id-ID');
      const arah     = sanitize(el('arah').value);

      return JSON.stringify({
        template:{
          engine:'gemini_veo3',
          project_title:'Proyek_Hiburan',
          global:{
            language:lang, style:'realistic_cinematic',
            aspect_ratio:'9:16', resolution:'1080x1920', fps:24,
            duration_per_scene_sec:8,
            color_grade:'teal_orange_moderate',
            camera_profile:'anamorphic_soft_bokeh',
            audio:{ voice_over:{enabled:true, voice_id:'id_female_soft', tone:'warm_storytelling', pace_wpm:145},
                    music:{global_theme:'orchestral_electronic_hybrid', mix_level_db:-16},
                    sfx:{lufs_target:-18} },
            safety:{ no_logo:true, no_trademark:true }
          },
          characters:[{ description:charIdea, notes:'tanpa merek nyata' }],
          scenes:[
            { id:1, duration_sec:8, visual_style:visual, camera:'wide â†’ push-in lembut',
              sfx:['ambience_room_soft','woosh_subtle'],
              actions:[
                'Establishing tokoh di ruang personal.',
                premis ? ('Premis: '+premis) : 'Premis: temuan anomali halus di ruang kerja.'
              ],
              voice_over:'Aku tak sengaja menemukan pintu kecil di dunia yang sudah sempit ini.' },
            { id:2, duration_sec:8, visual_style:visual, camera:'handheld halus, eye-level',
              sfx:['low_rumble','soft_chime'],
              actions:['Tokoh berinteraksi dengan anomali; close-up emosi & cahaya.'],
              voice_over:'Di baliknya, ada sunyi yang berbicaraâ€”dan aku mendengarnya.' },
            { id:3, duration_sec:8, visual_style:visual, camera:'slow dolly-out',
              sfx:['heartbeat_soft','air_whisper'],
              actions:[
                'Konsekuensi pertama muncul; sesuatu menyeberang ke sini.',
                arah ? ('Catatan sutradara: '+arah) : 'Catatan sutradara: akhir terbuka, nada bittersweet.'
              ],
              voice_over:'Kalau rumah adalah rahasia, mungkin aku pulang ke yang tak bernama.' }
          ]
        }
      }, null, 2);
    }

    function buildAfiliasi(){
      const brand   = sanitize(el('brand').value);
      const premis  = sanitize(el('premisAd').value);
      const benefit = sanitize(el('benefit').value);
      const cta     = sanitize(el('cta').value || 'KLIK KERANJANG KUNING / BELI SEKARANG');
      const lang    = sanitize(el('langAd').value || 'id-ID');

      const list = benefit ? benefit.split(/,|;|\n/).map(s=>s.trim()).filter(Boolean).slice(0,3) : [];
      const voHook = `Butuh upgrade cepat? ${brand || 'Brand kamu'} jawabannya.`;
      const voBody = list.length >= 2 ? `${list[0]}; ${list[1]}.` : 'Desain rapi, nyaman dipakai.';

      return JSON.stringify({
        ad_prompt:{
          engine:'gemini_veo3',
          project_title:`Iklan_${brand||'TanpaNama'}`,
          global:{
            language:lang, style:'realistic_cinematic',
            aspect_ratio:'9:16', resolution:'1080x1920', fps:24,
            duration_total_sec:8,
            safety:{ no_logo:true, no_price:true, no_health_claim:true }
          },
          script:{ hook:voHook, body:voBody, cta },
          scenes:[
            { id:1, duration_sec:3,
              actions:[ premis ? `Mulai: ${premis}` : 'Tangan memegang objek biasa di meja; cahaya natural.' ],
              text_overlay:'Upgrade sekarang', audio:{ voice_over: voHook } },
            { id:2, duration_sec:1, actions:['Transisi â€œwooshâ€ cepat, efek partikel halus.'], sfx:['whoosh_light'] },
            { id:3, duration_sec:4,
              actions:['Objek â†’ versi aesthetic; close-up detail; senyum ke kamera.'],
              text_overlay: brand || 'Merek Anda',
              audio:{ voice_over: `${voBody} ${cta}` } }
          ]
        }
      }, null, 2);
    }

    // ===== MAIN BUTTONS =====
    el('genBtn').addEventListener('click', ()=>{
      const isAd = modeEl.value === 'afiliasi';
      out.value = isAd ? buildAfiliasi() : buildHiburan();
    });
    el('copyBtn').addEventListener('click', async ()=>{
      out.select();
      try { await navigator.clipboard.writeText(out.value || ''); alert('JSON disalin.'); }
      catch{ document.execCommand('copy'); alert('JSON disalin (fallback).'); }
    });

    // ===== AI ASSIST via OpenRouter (tanpa Google Cloud) =====
    async function aiJSON(userPrompt, schemaHint){
      const key = (el('orKey')?.value || '').trim();
      if(!key){ alert('Isi OpenRouter API Key dulu atau abaikan fitur AI.'); return null; }

      const body = {
        model: "google/gemma-2-9b-it:free",   // bisa ganti model lain di OpenRouter
        messages: [
          { role: "system", content: forceJSONSystem(schemaHint) },
          { role: "user",   content: userPrompt }
        ],
        temperature: 0.6
      };

      const res = await fetch("https://openrouter.ai/api/v1/chat/completions",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${key}`,
          "HTTP-Referer": location.origin,
          "X-Title": "Mesin Prompt Veo3"
        },
        body: JSON.stringify(body)
      });

      const data = await res.json();
      const text = data?.choices?.[0]?.message?.content || "";
      const parsed = cleanToJSON(text);
      if(!parsed){
        console.warn("AI raw output (non-JSON):", text);
        alert("AI tidak mengembalikan JSON yang valid.");
        return null;
      }
      return parsed;
    }

    // AI Assist: Isi 3 Scene
    el('assistScenes').addEventListener('click', async ()=>{
      const isAd = el('mode').value === 'afiliasi';

      if(isAd){
        const brand = (el('brand').value || 'produk').trim();
        const prem  = (el('premisAd').value || 'transisi objek jadi versi aesthetic').trim();

        const schema = `[{"visual":"deskripsi shot sinematik","voice_over":"naskah VO satu kalimat"}]`;
        const prompt = `Buat TEPAT 3 objek array JSON untuk iklan 8 detik Bahasa Indonesia.
- Fokus soft-selling untuk brand "${brand}".
- Premis: "${prem}".
- Tiap objek WAJIB punya "visual" dan "voice_over".
- Jangan tambahkan kalimat di luar JSON.`;

        const arr = await aiJSON(prompt, schema);
        if(!Array.isArray(arr) || arr.length===0) return;

        const base = JSON.parse(buildAfiliasi());
        arr.slice(0,3).forEach((s,i)=>{
          if(base.ad_prompt.scenes[i]){
            base.ad_prompt.scenes[i].actions = [ (s.visual||"").toString() ];
            base.ad_prompt.scenes[i].audio   = { voice_over: (s.voice_over||"").toString() };
          }
        });
        el('output').value = JSON.stringify(base,null,2);
        alert('Scene terisi oleh AI (afiliasi).');
      } else {
        const charIdea = (el('charIdea').value || 'seseorang yang kesepian').trim();
        const prem     = (el('premis').value || 'menemukan pintu kecil di laci').trim();

        const schema = `[{"visual":"deskripsi shot sinematik","voice_over":"naskah VO satu kalimat"}]`;
        const prompt = `Buat TEPAT 3 objek array JSON untuk cerita sinematik (8 detik per scene), Bahasa Indonesia.
- Karakter: ${charIdea}
- Premis: ${prem}
- Tiap objek WAJIB punya "visual" dan "voice_over".
- Jangan tambahkan kalimat di luar JSON.`;

        const arr = await aiJSON(prompt, schema);
        if(!Array.isArray(arr) || arr.length===0) return;

        const base = JSON.parse(buildHiburan());
        arr.slice(0,3).forEach((s,i)=>{
          if(base.template.scenes[i]){
            base.template.scenes[i].actions    = [ (s.visual||"").toString() ];
            base.template.scenes[i].voice_over = (s.voice_over||"").toString();
          }
        });
        el('output').value = JSON.stringify(base,null,2);
        alert('Scene terisi oleh AI (hiburan).');
      }
    });

    // AI Perbaiki VO
    el('assistCopy').addEventListener('click', async ()=>{
      const current = el('output').value || '';
      if(!current.trim()){ alert('Generate dulu atau tempel JSON yang ingin diperhalus.'); return; }

      const schema = "Kembalikan JSON yang sama persis struktur key-nya, hanya perbaiki redaksi teks.";
      const prompt = `Perhalus copywriting Bahasa Indonesia di dalam JSON berikut.
- JANGAN ubah struktur kunci atau menambah/menghapus field.
- Hanya perbaiki kalimat (tone sinematik, natural).
- Kembalikan HANYA JSON.
JSON:
${current}`;

      const fixed = await aiJSON(prompt, schema);
      if(!fixed) return;
      el('output').value = JSON.stringify(fixed, null, 2);
      alert('Copy diperhalus AI.');
    });
  </script>
</body>
</html>
