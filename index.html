<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIonade Continuum — Local First (No Billing)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --bg-dark:#111827; --bg-med:#1f2937; --bg-light:#374151; --border:#4b5563; --text:#f9fafb; --muted:#d1d5db; --blue:#3b82f6; --indigo:#6366f1; --red:#ef4444; --green:#22c55e; }
    body{font-family:'Inter',sans-serif;background-color:var(--bg-dark);color:var(--muted)}
    .hub-section{background-color:var(--bg-med);border:1px solid var(--bg-light)}
    .form-input,.form-select,.form-textarea{background-color:var(--bg-light);border:1px solid var(--border);color:var(--text);transition:all .2s}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 2px rgba(59,130,246,.4)}
    .btn{transition:all .2s;cursor:pointer}
    .btn-primary{background-color:var(--blue);color:#fff}.btn-primary:hover:not(:disabled){background-color:#2563eb}
    .btn-secondary{background-color:var(--bg-light);color:#fff}.btn-secondary:hover:not(:disabled){background-color:#4b5563}
    .btn-danger{background-color:#dc2626;color:#fff}.btn-danger:hover:not(:disabled){background-color:#b91c1c}
    .btn-ai{background-color:var(--indigo);color:#fff;padding:6px 12px;font-size:14px;font-weight:500;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;gap:6px}
    .btn-ai:hover:not(:disabled){background-color:#4f46e5}
    .btn:disabled{background-color:#6b7280;opacity:.7;cursor:not-allowed}
    .notification{position:fixed;bottom:-100px;left:50%;transform:translateX(-50%);color:#fff;padding:12px 24px;border-radius:8px;z-index:100;opacity:0;transition:all .4s cubic-bezier(.25,.8,.25,1)}
    .notification.show{opacity:1;bottom:20px}
    .notification.success{background-color:var(--green)}.notification.error{background-color:var(--red)}
    .loader{width:14px;height:14px;border:2px solid #fff;border-bottom-color:transparent;border-radius:50%;display:inline-block;box-sizing:border-box;animation:rotation 1s linear infinite}
    @keyframes rotation{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .json-output{background:#0c111d;border:1px solid var(--bg-light);color:#a5b4fc;white-space:pre-wrap;word-wrap:break-word;font-size:12px}
    .radio-label{padding:8px 16px;border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .2s}
    input[type="radio"]:checked + .radio-label{background-color:var(--indigo);border-color:var(--indigo);color:#fff}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #374151;color:#a5b4fc;border-radius:6px;padding:2px 6px;font-size:12px}
  </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
  <!--
    AIonade Continuum — Local First (No Billing)
    • Default: TEKS offline via WebLLM (WebGPU). Tidak ada server & tidak pakai Gemini/OpenAI billing.
    • Opsi Cloud: OpenRouter (user memasukkan API key sendiri) untuk TEKS/GAMBAR.
    • Gambar lokal tidak dihasilkan; untuk gambar gunakan OpenRouter.
  -->
  <div class="max-w-7xl mx-auto">
    <div id="editor-view">
      <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-white">AIonade Continuum</h1>
        <p class="mt-2 text-lg text-gray-400">Dari premis ke publikasi, konsisten di setiap frame.</p>
      </header>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Col 1: Settings -->
        <div class="lg:col-span-1 space-y-6">
          <section class="hub-section p-6 rounded-lg sticky top-8">
            <div class="flex justify-between items-center border-b border-gray-600 pb-3 mb-4">
              <h2 class="text-2xl font-semibold text-white">1. Pengaturan Proyek</h2>
            </div>
            <div class="space-y-4">
              <div>
                <label for="language-selector" class="block text-sm font-medium mb-2">Bahasa</label>
                <select id="language-selector" class="form-select rounded-md p-2 w-full">
                  <option value="id" selected>Bahasa Indonesia</option>
                  <option value="en">English</option>
                  <option value="zh">中文 (Chinese)</option>
                </select>
              </div>

              <!-- Provider: Local vs OpenRouter -->
              <div class="space-y-2">
                <label class="block text-sm font-medium mb-2">Provider</label>
                <div class="grid grid-cols-2 gap-2">
                  <button id="provider-local" class="btn btn-secondary py-2 rounded-md font-medium" data-active="true">Local (WebLLM)</button>
                  <button id="provider-openrouter" class="btn btn-secondary py-2 rounded-md font-medium">OpenRouter (Cloud)</button>
                </div>
                <p class="text-xs text-gray-400">Pilih <span class="kbd">OpenRouter</span> jika ingin model cloud (API key user). Default: Lokal.</p>
              </div>

              <!-- Local Model selector -->
              <div id="local-config">
                <label for="model-selector" class="block text-sm font-medium mb-2">Local Model (WebLLM)</label>
                <select id="model-selector" class="form-select rounded-md p-2 w-full">
                  <option value="Qwen2.5-1.5B-Instruct-q4f16_1-MLC">Qwen2.5 1.5B Instruct (fast)</option>
                  <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B Instruct (lightest)</option>
                  <option value="Phi-3-mini-4k-instruct-q4f16_1-MLC">Phi-3 Mini 4K Instruct (balanced)</option>
                </select>
                <p class="mt-1 text-xs text-gray-400">Model berjalan di perangkat Anda. Unduhan awal 200–600MB.</p>
              </div>

              <!-- OpenRouter Config -->
              <div id="openrouter-config" class="hidden space-y-3">
                <div>
                  <label for="openrouter-key" class="block text-sm font-medium mb-1">OpenRouter API Key <span class="text-yellow-400">(wajib)</span></label>
                  <input type="password" id="openrouter-key" class="form-input rounded-md p-2 w-full" placeholder="sk-or-v1-..." autocomplete="off" />
                  <p class="text-xs text-gray-400 mt-1">Kunci hanya hidup di memori tab (tidak disimpan server).</p>
                </div>
                <div class="grid grid-cols-1 gap-3">
                  <div>
                    <label for="openrouter-text-model" class="block text-sm font-medium mb-1">Text Model</label>
                    <select id="openrouter-text-model" class="form-select rounded-md p-2 w-full">
                      <option value="mistralai/mistral-small">mistralai/mistral-small</option>
                      <option value="qwen/qwen-2.5-7b-instruct">qwen/qwen-2.5-7b-instruct</option>
                      <option value="meta-llama/llama-3.1-8b-instruct">meta-llama/llama-3.1-8b-instruct</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Sesuaikan dengan model ID yang tersedia di akun OpenRouter Anda.</p>
                  </div>
                  <div>
                    <label for="openrouter-image-model" class="block text-sm font-medium mb-1">Image Model (3 opsi community/sering gratis)</label>
                    <select id="openrouter-image-model" class="form-select rounded-md p-2 w-full">
                      <option value="stability/stable-diffusion-xl">stability/stable-diffusion-xl</option>
                      <option value="playgroundai/playground-v2.5">playgroundai/playground-v2.5</option>
                      <option value="black-forest-labs/flux-schnell">black-forest-labs/flux-schnell</option>
                    </select>
                    <input id="openrouter-image-override" class="form-input rounded-md p-2 w-full mt-2" placeholder="(Opsional) Override model id, mis. stability/stable-diffusion-3" />
                    <p class="text-xs text-gray-400 mt-1">Ketersediaan/gratis berubah-ubah; Anda bisa override model ID.</p>
                  </div>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Tujuan Cerita</label>
                <div class="flex gap-4">
                  <input type="radio" name="purpose" id="purpose-entertainment" value="entertainment" class="sr-only" checked />
                  <label for="purpose-entertainment" class="radio-label flex-1 text-center">Hiburan</label>
                  <input type="radio" name="purpose" id="purpose-affiliate" value="affiliate" class="sr-only" />
                  <label for="purpose-affiliate" class="radio-label flex-1 text-center">Afiliasi</label>
                </div>
              </div>

              <div id="affiliate-details" class="hidden space-y-4 pt-4 border-t border-gray-700">
                <h3 class="text-md font-semibold text-gray-300">Detail Afiliasi</h3>
                <div>
                  <label for="product-name" class="block text-sm font-medium mb-1">Nama Produk</label>
                  <input type="text" id="product-name" class="form-input rounded-md p-2 w-full" placeholder="Contoh: Smartwatch Kronos V2" />
                </div>
                <div>
                  <label for="product-image-input" class="block text-sm font-medium mb-1">Referensi Gambar Produk</label>
                  <div id="image-upload-container" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-md">
                    <div id="image-upload-prompt" class="space-y-1 text-center">
                      <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      <div class="flex text-sm text-gray-500">
                        <label for="product-image-input" class="relative cursor-pointer bg-gray-800 rounded-md font-medium text-indigo-400 hover:text-indigo-300">Unggah file</label>
                        <p class="pl-1">atau tarik dan lepas</p>
                      </div>
                      <p class="text-xs text-gray-600">PNG, JPG, WEBP</p>
                    </div>
                    <div id="image-preview-container" class="hidden w-full text-center">
                      <img id="image-preview" src="#" class="mx-auto max-h-32 rounded-lg" alt="Product Image Preview" />
                      <button id="remove-image-btn" class="mt-2 text-sm text-red-400 hover:text-red-300">Hapus Gambar</button>
                    </div>
                  </div>
                  <p class="mt-2 text-xs text-yellow-400">Catatan: model lokal tidak "melihat" gambar; unggahan hanya untuk referensi visual pengguna.</p>
                </div>
              </div>

              <hr class="my-4 border-gray-600" />

              <div id="character-idea-container">
                <label for="character-idea" class="block text-sm font-medium mb-1">2. Ide Karakter</label>
                <textarea id="character-idea" class="form-textarea rounded-md p-2 w-full" rows="3" placeholder="Contoh: Seekor kucing oranye dengan pedang perak berkilauan..."></textarea>
              </div>
              <button id="generate-character-btn" class="btn btn-ai w-full">✨ 3. Buat Karakter Utama</button>

              <div id="character-concept-container" class="mt-4 hidden">
                <label class="block text-sm font-medium mb-2">Character Concept</label>
                <div id="character-image-placeholder" class="aspect-square bg-gray-900 rounded-lg flex items-center justify-center border border-dashed border-gray-600">
                  <p class="text-gray-500 text-sm">Menunggu konsep karakter...</p>
                </div>
                <label class="block text-sm font-medium mt-2 mb-1">Lembar Karakter (Dapat Diedit)</label>
                <textarea id="character-sheet-output" class="json-output p-2 rounded-md mt-1 text-xs w-full h-32"></textarea>
              </div>

              <hr class="my-4 border-gray-600" />

              <div>
                <label for="core-idea" class="block text-sm font-medium mb-1">4. Masukkan Premis Cerita</label>
                <textarea id="core-idea" class="form-textarea rounded-md p-2 w-full" rows="4" placeholder="Contoh: Di sebuah kota yang terus hujan, ia menemukan jam yang bisa menghentikan waktu..."></textarea>
              </div>
              <div>
                <label for="story-directives" class="block text-sm font-medium mb-1">5. Arahan Cerita (Opsional)</label>
                <input type="text" id="story-directives" class="form-input rounded-md p-2 w-full" placeholder="Contoh: menegangkan, akhir yang mengejutkan..." />
                <button id="generate-story-btn" class="btn btn-ai w-full mt-2">✨ Generate/Isi Story Arc</button>
              </div>

              <hr class="my-6 border-gray-600" />
              <h2 class="text-xl font-semibold text-white mb-4">Global Settings</h2>
              <div class="space-y-4">
                <div>
                  <label for="continuity-seed" class="block text-sm font-medium mb-1">Continuity Seed</label>
                  <input type="number" id="continuity-seed" class="form-input rounded-md p-2 w-full bg-gray-900" readonly />
                </div>
                <div>
                  <label for="project_style" class="block text-sm font-medium mb-1">Visual Style</label>
                  <input type="text" id="project_style" value="realistic_cinematic, 4k, dramatic lighting" class="form-input rounded-md p-2 w-full" />
                </div>
              </div>

              <!-- Diagnostics / Test Cases -->
              <div class="mt-6 hub-section p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-white mb-2">Diagnostics</h3>
                <div class="text-sm text-gray-300 space-y-2">
                  <p>• Uji engine WebLLM (lokal) & OpenRouter (cloud).</p>
                  <div class="flex gap-2 flex-wrap">
                    <button id="btn-test-factory" class="btn btn-secondary px-3 py-1">Test Engine Factory</button>
                    <button id="btn-test-generate" class="btn btn-secondary px-3 py-1">Test Generate JSON (Local)</button>
                    <button id="btn-test-or-text" class="btn btn-secondary px-3 py-1">Test OR Text</button>
                    <button id="btn-test-or-img" class="btn btn-secondary px-3 py-1">Test OR Image</button>
                    <button id="btn-reset-engine" class="btn btn-danger px-3 py-1">Reset Engine</button>
                  </div>
                  <pre id="diag-log" class="json-output p-2 rounded-md mt-2 h-48 overflow-auto"></pre>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Col 2: Scenes & Production -->
        <div class="lg:col-span-2 space-y-6">
          <section class="hub-section p-6 rounded-lg">
            <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-3 mb-4">Storyboard</h2>
            <div id="scenes-container" class="space-y-6">
              <p class="text-center text-gray-400 py-8">Buat karakter untuk memulai storyboard Anda.</p>
            </div>
            <button id="add-scene-btn" class="btn btn-secondary w-full mt-4 py-2">Tambah Adegan Manual</button>
          </section>

          <section class="hub-section p-6 rounded-lg">
            <h2 class="text-2xl font-semibold text-white mb-4">Production</h2>
            <button id="proceed-btn" class="btn btn-primary w-full px-4 py-3 rounded-md font-bold text-lg">Generate Production Prompts →</button>
          </section>
        </div>
      </div>
    </div>

    <!-- View: Production Deck -->
    <div id="deck-view" class="hidden">
      <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-white">Production Deck</h1>
        <p class="mt-2 text-lg text-gray-400">Tiga prompt JSON siap pakai (mesin generik). Gunakan satu per satu.</p>
      </header>
      <div id="json-deck-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
      <div class="text-center mt-8">
        <button id="back-to-editor-btn" class="btn btn-secondary py-2 px-6">← Kembali ke Editor</button>
      </div>
    </div>
  </div>

  <!-- Templates & Notification -->
  <template id="scene-template">
    <div class="scene-card p-4 rounded-lg border-l-4 border-indigo-500 bg-gray-800/50">
      <div class="flex justify-between items-start mb-3">
        <h3 class="scene-title text-xl font-bold text-white">Scene</h3>
        <button class="remove-scene-btn btn btn-danger p-1 rounded-full leading-none">&times;</button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <label class="block text-sm font-medium mb-1">Visual Description</label>
          <textarea data-key="visual" class="form-textarea rounded-md p-2 w-full" rows="4"></textarea>
        </div>
        <div class="sm:col-span-2">
          <label class="block text-sm font-medium mb-1">Voice Over</label>
          <textarea data-key="voice_over" class="form-textarea rounded-md p-2 w-full" rows="2"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Shot Type</label>
          <select data-key="shot_type" class="form-select rounded-md p-2 w-full">
            <option value="">-- Select --</option>
            <option value="wide_establishing">Wide Establishing</option>
            <option value="medium_shot">Medium Shot</option>
            <option value="emotive_closeup">Emotive Closeup</option>
            <option value="dutch_angle">Dutch Angle</option>
            <option value="pov">Point of View (POV)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Camera Movement</label>
          <select data-key="camera" class="form-select rounded-md p-2 w-full">
            <option value="">-- Select --</option>
            <option value="static">Static</option>
            <option value="slow_push_in">Slow Push-in</option>
            <option value="drone_shot">Drone Shot</option>
            <option value="handheld">Handheld</option>
            <option value="circular_orbit">Circular Orbit</option>
          </select>
        </div>
      </div>
    </div>
  </template>

  <template id="json-card-template">
    <div class="hub-section p-4 rounded-lg flex flex-col">
      <h3 class="json-title text-lg font-bold text-white mb-2"></h3>
      <pre class="json-output p-3 rounded-md h-96 overflow-auto flex-grow"></pre>
      <button class="copy-json-btn btn btn-secondary w-full mt-4 text-sm py-2">Copy JSON</button>
    </div>
  </template>

  <div id="notification" class="notification"></div>

  <!-- App Script -->
  <script type="module">
    // Import WebLLM (ESM)
    import * as webllm from 'https://esm.run/@mlc-ai/web-llm@0.2.36';

    // --- Helpers & State ---
    const $ = (id) => document.getElementById(id);
    const qs = (sel, el=document) => el.querySelector(sel);
    let isAIBusy=false, currentLang='id', characterSheet=null, productImageBase64=null;

    // DOM refs
    const editorView=$('editor-view'), deckView=$('deck-view'), scenesContainer=$('scenes-container');
    const jsonDeckContainer=$('json-deck-container'), sceneTemplate=$('scene-template'), jsonCardTemplate=$('json-card-template');
    const notificationEl=$('notification'), generateStoryBtn=$('generate-story-btn'), generateCharacterBtn=$('generate-character-btn');
    const addSceneBtn=$('add-scene-btn'), proceedBtn=$('proceed-btn'), backToEditorBtn=$('back-to-editor-btn');
    const continuitySeedInput=$('continuity-seed'), affiliateDetails=$('affiliate-details'), languageSelector=$('language-selector');
    const modelSelector=$('model-selector'), productImageInput=$('product-image-input');
    const imageUploadPrompt=$('image-upload-prompt'), imagePreviewContainer=$('image-preview-container');
    const imagePreview=$('image-preview'), removeImageBtn=$('remove-image-btn');
    const providerLocalBtn=$('provider-local'), providerCloudBtn=$('provider-openrouter');
    const cloudConfig=$('openrouter-config');
    const orKeyInput=$('openrouter-key'), orTextModel=$('openrouter-text-model');
    const orImageModel=$('openrouter-image-model'), orImageOverride=$('openrouter-image-override');
    const diagLog=$('diag-log');
    let provider='local';

    // i18n minimal
    function setLanguage(lang){currentLang=lang;document.documentElement.lang=lang;}
    languageSelector.addEventListener('change',e=>setLanguage(e.target.value));

    function showNotification(msgKey,type='success',ms=3000){const msg=msgKey;notificationEl.textContent=msg;notificationEl.className='notification';notificationEl.classList.add(type,'show');setTimeout(()=>notificationEl.classList.remove('show'),ms)}
    function toggleAILock(lock){isAIBusy=lock;document.querySelectorAll('.btn-ai,#proceed-btn').forEach(b=>b.disabled=lock)}
    function extractJson(text){if(!text||typeof text!=='string')return null;const idx=[text.indexOf('{'),text.indexOf('[')].filter(i=>i>=0);if(!idx.length)return null;const first=Math.min(...idx);const last=Math.max(text.lastIndexOf('}'),text.lastIndexOf(']'));if(last<first)return null;try{return JSON.parse(text.substring(first,last+1))}catch{return null}}

    // Provider toggle
    providerLocalBtn.addEventListener('click',()=>{provider='local';providerLocalBtn.dataset.active='true';providerCloudBtn.dataset.active='false';$('local-config').classList.remove('hidden');cloudConfig.classList.add('hidden');showNotification('Mode Local (WebLLM).','success',1200)});
    providerCloudBtn.addEventListener('click',()=>{provider='openrouter';providerCloudBtn.dataset.active='true';providerLocalBtn.dataset.active='false';$('local-config').classList.add('hidden');cloudConfig.classList.remove('hidden');showNotification('Mode OpenRouter (Cloud).','success',1200)});

    // Image upload (affiliate)
    productImageInput?.addEventListener('change',(e)=>{const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=ev=>{productImageBase64=ev.target.result;imagePreview.src=ev.target.result;imageUploadPrompt.classList.add('hidden');imagePreviewContainer.classList.remove('hidden')};r.readAsDataURL(f)});
    removeImageBtn?.addEventListener('click',()=>{productImageBase64=null;productImageInput.value='';imageUploadPrompt.classList.remove('hidden');imagePreviewContainer.classList.add('hidden')});

    // Purpose
    document.querySelectorAll('input[name="purpose"]').forEach(r=>r.addEventListener('change',e=>{const isAff=e.target.value==='affiliate';affiliateDetails.classList.toggle('hidden',!isAff);$('character-idea-container').classList.toggle('hidden',isAff);$('generate-character-btn').classList.toggle('hidden',isAff);$('character-concept-container').classList.toggle('hidden',isAff);resetWorkflow()}));

    // Scenes helpers
    function addScene(d={}){const frag=sceneTemplate.content.cloneNode(true);qs('[data-key="visual"]',frag).value=d.visual||'';qs('[data-key="voice_over"]',frag).value=d.voice_over||'';qs('[data-key="shot_type"]',frag).value=d.shot_type||'';qs('[data-key="camera"]',frag).value=d.camera||'';scenesContainer.appendChild(frag);updateSceneTitles()}
    function updateSceneTitles(){const scenes=scenesContainer.querySelectorAll('.scene-card');if(!scenes.length){scenesContainer.innerHTML='<p class="text-center text-gray-400 py-8">Buat karakter untuk memulai storyboard Anda.</p>'}else{scenes.forEach((s,i)=>{qs('.scene-title',s).textContent=`Scene ${i+1}`})}}
    function resetWorkflow(){$('core-idea').value='';$('character-idea').value='';$('story-directives').value='';$('character-concept-container').classList.add('hidden');characterSheet=null;scenesContainer.innerHTML='<p class="text-center text-gray-400 py-8">Buat karakter untuk memulai storyboard Anda.</p>'}

    // --- WebLLM local (text) ---
    let engine=null, engineReady=false, selectedModel=null, appConfig=null;
    function logDiag(obj){if(!diagLog)return;const t=new Date().toLocaleTimeString();diagLog.textContent+=`
[${t}] ${typeof obj==='string'?obj:JSON.stringify(obj,null,2)}`;diagLog.scrollTop=diagLog.scrollHeight}
    function resolveEngineFactory(mod){const ns=[mod,mod?.default].filter(Boolean);const cands=['CreateEngine','CreateWebWorkerMLCEngine','CreateServiceWorkerEngine','CreateWebServiceWorkerEngine','CreateMLCEngine','createMLCEngine','createEngine'];for(const n of ns){for(const k of cands){const v=n[k];if(typeof v==='function')return{fn:v.bind(n),name:k,ns:n===mod?'module':'default'}}}return null}
    function populateModelSelector(){const list=(appConfig?.model_list||[]).map(m=>m.model_id);const prefer=['Qwen2.5-1.5B-Instruct-q4f16_1-MLC','Llama-3.2-1B-Instruct-q4f16_1-MLC','Phi-3-mini-4k-instruct-q4f16_1-MLC'].filter(id=>list.includes(id));const ids=prefer.length?prefer:list;modelSelector.innerHTML='';ids.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;modelSelector.appendChild(o)});selectedModel=modelSelector.value}
    async function ensureEngine(){if(engineReady&&engine)return engine;if(!('gpu'in navigator))alert('Browser Anda tidak mendukung WebGPU. Coba Chrome/Edge terbaru.');appConfig=webllm.prebuiltAppConfig||webllm?.default?.prebuiltAppConfig||appConfig;if(!appConfig)throw new Error('prebuiltAppConfig tidak tersedia dari webllm.');if(!modelSelector.options.length)populateModelSelector();let factory=resolveEngineFactory(webllm)||resolveEngineFactory(webllm?.default);if(!factory){const all=[...Object.keys(webllm||{}),...Object.keys(webllm?.default||{})];throw new Error('WebLLM engine factory tidak ditemukan. Ekspor: '+all.join(', '))}logDiag(`Factory: ${factory.name} (ns=${factory.ns})`);const ids=(appConfig.model_list||[]).map(m=>m.model_id);if(!ids.includes(selectedModel)){selectedModel=ids[0];modelSelector.value=selectedModel;logDiag('Fallback model: '+selectedModel)}const bar=document.createElement('div');bar.className='fixed bottom-6 left-1/2 -translate-x-1/2 w-11/12 sm:w-2/3 md:w-1/2 bg-gray-800 rounded-lg overflow-hidden border border-gray-700 z-50';bar.innerHTML=`<div class="px-4 py-2 text-xs text-gray-300">Init model lokal (${selectedModel})… <span id="dlp">0%</span></div><div class="h-1 bg-gray-700"><div id="dll" class="h-1 bg-indigo-500" style="width:0%"></div></div>`;document.body.appendChild(bar);const dlp=()=>$('dlp'),dll=()=>$('dll');engine=await factory.fn(selectedModel,{appConfig,initProgressCallback:(r)=>{if(r&&r.progress!=null){const p=Math.floor(r.progress*100);if(dlp())dlp().textContent=p+'%';if(dll())dll().style.width=p+'%'}}});engineReady=true;setTimeout(()=>bar.remove(),600);return engine}
    modelSelector.addEventListener('change',e=>{selectedModel=e.target.value;try{engine?.dispose?.()}catch{}engine=null;engineReady=false;showNotification('Model diganti. Akan diunduh saat generasi berikutnya.','success',2000)})
    async function callLocalLLM(prompt,btn){if(isAIBusy)return null;toggleAILock(true);const ori=btn.innerHTML;btn.innerHTML='<span class="loader"></span> Generating…';try{await ensureEngine();const sys='Jawab ringkas dan bila diminta kembalikan JSON murni.';let text='';if(engine?.chat?.completions?.create){const r=await engine.chat.completions.create({messages:[{role:'system',content:sys},{role:'user',content:prompt}],temperature:0.7,stream:false,max_tokens:512});text=r?.choices?.[0]?.message?.content?.trim?.()||''}else if(engine?.chat?.generate){const r=await engine.chat.generate([{role:'system',content:sys},{role:'user',content:prompt}],{temperature:0.7,maxTokens:512});text=r?.output_text||r?.text||''}else if(engine?.generate){const r=await engine.generate(prompt,{system:sys,temperature:0.7,maxTokens:512});text=r?.output_text||r?.text||''}else{throw new Error('Tidak ada API generate yang kompatibel.')}return text}catch(e){console.error(e);logDiag(String(e));showNotification('Gagal memproses lokal','error',3000);return null}finally{btn.innerHTML=ori;toggleAILock(false)}}

    // --- OpenRouter helpers ---
    function requireORKey(){const k=(orKeyInput?.value||'').trim();if(!k){showNotification('Masukkan OpenRouter API Key.','error',2500);return null}return k}
    function currentImageModel(){return (orImageOverride?.value?.trim())||orImageModel.value}
    async function callOpenRouterText(prompt,btn){if(isAIBusy)return null;const key=requireORKey();if(!key)return null;toggleAILock(true);const ori=btn.innerHTML;btn.innerHTML='<span class="loader"></span> Generating…';try{const body={model:orTextModel.value,messages:[{role:'system',content:'Jawab ringkas dan bila diminta kembalikan JSON murni.'},{role:'user',content:prompt}]};const resp=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`,'HTTP-Referer':location.origin,'X-Title':'AIonade Continuum'},body:JSON.stringify(body)});const json=await resp.json();if(!resp.ok)throw new Error(json?.error?.message||JSON.stringify(json));return json?.choices?.[0]?.message?.content||''}catch(e){console.error(e);logDiag('OpenRouter Text Error: '+String(e));showNotification('Gagal OR Text','error',3000);return null}finally{btn.innerHTML=ori;toggleAILock(false)}}
    async function callOpenRouterImage(prompt,btn){const key=requireORKey();if(!key)return null;toggleAILock(true);const ori=btn.innerHTML;btn.innerHTML='<span class="loader"></span> Rendering…';try{const body={model:currentImageModel(),prompt,size:'1024x1024',n:1,response_format:'b64_json'};const resp=await fetch('https://openrouter.ai/api/v1/images',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`,'HTTP-Referer':location.origin,'X-Title':'AIonade Continuum'},body:JSON.stringify(body)});const json=await resp.json();if(!resp.ok)throw new Error(json?.error?.message||JSON.stringify(json));const d=json?.data?.[0];if(d?.b64_json)return `data:image/png;base64,${d.b64_json}`;if(d?.url)return d.url;throw new Error('Tidak ada gambar pada respons.')}catch(e){console.error(e);logDiag('OpenRouter Image Error: '+String(e));showNotification('Gagal OR Image','error',3000);return null}finally{btn.innerHTML=ori;toggleAILock(false)}}

    // Character Generation
    $('generate-character-btn').addEventListener('click',async(e)=>{
      const idea=$('character-idea').value?.trim();if(!idea)return showNotification('Masukkan ide karakter dulu.','error');
      $('character-concept-container').classList.remove('hidden');const imgBox=$('character-image-placeholder');const sheetOut=$('character-sheet-output');sheetOut.value='';imgBox.innerHTML=`<div class="flex flex-col items-center gap-2"><span class="loader"></span><p class="text-sm text-gray-400">Mempersiapkan...</p></div>`;
      const sheetPrompt=`Buat JSON lembar karakter dari ide: "${idea}". Kunci wajib: name, description (fisik+kepribadian), clothing (detail), key_items (array), traits (array), backstory (1 paragraf). Gunakan Bahasa Indonesia.`;
      const textOut=(provider==='openrouter')?await callOpenRouterText(sheetPrompt,e.target):await callLocalLLM(sheetPrompt,e.target);
      if(!textOut){sheetOut.value='Gagal mengambil data karakter.';return}
      const parsed=extractJson(textOut);if(!parsed||!parsed.name||!parsed.description){sheetOut.value='Gagal parsing data karakter.';return showNotification('Respons AI tidak valid.','error')}
      sheetOut.value=JSON.stringify(parsed,null,2);characterSheet=parsed;
      const style=$('project_style').value;const imagePrompt=`full body concept art of ${idea}. Style: ${style}.`;
      if(provider==='openrouter'){
        const url=await callOpenRouterImage(imagePrompt,e.target);
        if(url){imgBox.innerHTML=`<img src="${url}" class="w-full h-full object-cover rounded-lg" alt="Character"/>`}
        else{imgBox.innerHTML=`<div class="w-full h-full flex items-center justify-center"><div class="text-center text-xs text-gray-400">Gagal membuat gambar.</div></div>`}
      }else{
        imgBox.innerHTML=`<div class="w-full h-full flex items-center justify-center"><div class="text-center text-xs text-gray-400">(Offline) Tidak menghasilkan gambar. Gunakan referensi visual sendiri.</div></div>`
      }
      showNotification('Karakter berhasil dibuat!','success');scenesContainer.innerHTML='';addScene();addScene();addScene();
    });

    // Story Arc Generation
    generateStoryBtn.addEventListener('click',async(e)=>{
      const coreIdea=$('core-idea').value?.trim();if(!coreIdea)return showNotification('Masukkan premis cerita terlebih dahulu.','error');
      const purpose=document.querySelector('input[name="purpose"]:checked').value;let sheet=null;if(purpose==='entertainment'){try{sheet=JSON.parse($('character-sheet-output').value||'{}')}catch{return showNotification('Harap buat karakter valid dulu.','error')}}
      const directives=$('story-directives').value||'';
      let prompt='';
      if(purpose==='affiliate'){
        const productName=$('product-name').value||'(nama produk belum diisi)';
        prompt=`Ini video afiliasi untuk produk "${productName}". Premis: "${coreIdea}". Arahan: ${directives}. Hasilkan 3 adegan (JSON array) dengan kunci 'visual', 'voice_over', 'shot_type', 'camera'. Hindari klaim berlebih/harga.`;
      }else{
        prompt=`Premis: "${coreIdea}". Character Sheet: ${JSON.stringify(sheet||{})}. Arahan: ${directives}. Hasilkan 3 adegan (JSON array) dengan 'visual', 'voice_over', 'shot_type', 'camera'.`;
      }
      const out=(provider==='openrouter')?await callOpenRouterText(prompt,e.target):await callLocalLLM(prompt,e.target);
      if(!out)return;const scenes=extractJson(out);if(Array.isArray(scenes)&&scenes.length>0){const cards=scenesContainer.querySelectorAll('.scene-card');scenes.forEach((s,i)=>{if(cards[i]){qs('[data-key="visual"]',cards[i]).value=s.visual||'';qs('[data-key="voice_over"]',cards[i]).value=s.voice_over||'';qs('[data-key="shot_type"]',cards[i]).value=s.shot_type||'';qs('[data-key="camera"]',cards[i]).value=s.camera||''}});showNotification('Story arc berhasil dibuat!','success')}else{showNotification('Respons AI tidak valid.','error')}});

    // Production Deck
    proceedBtn.addEventListener('click',()=>{
      const scenes=[...document.querySelectorAll('.scene-card')];if(!scenes.length)return showNotification('Buat setidaknya satu adegan terlebih dahulu.','error');
      const seed=$('continuity-seed').value, style=$('project_style').value; jsonDeckContainer.innerHTML=''; let sheet=null;try{sheet=JSON.parse($('character-sheet-output').value||'{}')}catch{}
      scenes.forEach((el,idx)=>{
        const payload={
          engine:'video_engine_generic',
          provider,
          global:{ style, aspect_ratio:'9:16', fps:24, generation:{ seed:parseInt(seed), guidance:7.5, negative_prompts:['cartoonish','text','watermark','blurry'] } },
          scenes:[{ id:`scene-${String(idx+1).padStart(2,'0')}`, duration_sec:8, visual:qs('[data-key="visual"]',el).value, voice_over:qs('[data-key="voice_over"]',el).value, shot_type:qs('[data-key="shot_type"]',el).value, camera:qs('[data-key="camera"]',el).value }]
        };
        if(sheet && Object.keys(sheet).length) payload.global.character_sheet=sheet;
        const card=jsonCardTemplate.content.cloneNode(true); qs('.json-title',card).textContent=`Prompt for Scene ${idx+1}`; qs('.json-output',card).textContent=JSON.stringify(payload,null,2); jsonDeckContainer.appendChild(card);
      });
      editorView.classList.add('hidden'); deckView.classList.remove('hidden');
    });

    backToEditorBtn.addEventListener('click',()=>{deckView.classList.add('hidden');editorView.classList.remove('hidden');});
    addSceneBtn.addEventListener('click',()=>{if(scenesContainer.querySelector('p'))scenesContainer.innerHTML='';addScene()});
    scenesContainer.addEventListener('click',e=>{if(e.target.classList.contains('remove-scene-btn')){e.target.closest('.scene-card').remove();updateSceneTitles()}});
    jsonDeckContainer.addEventListener('click',e=>{if(e.target.classList.contains('copy-json-btn')){const t=e.target.previousElementSibling.textContent;const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();try{document.execCommand('copy');showNotification('JSON disalin ke clipboard!','success')}catch{showNotification('Gagal menyalin.','error')}document.body.removeChild(ta)}});

    // Diagnostics
    function assertOk(name,cond,extra=''){logDiag((cond?'✅ ':'❌ ')+name+(extra?(' — '+extra):''))}
    $('btn-reset-engine').addEventListener('click',()=>{try{engine?.dispose?.()}catch{}engine=null;engineReady=false;logDiag('Engine direset.');showNotification('Reset selesai.','success',1200)})
    $('btn-test-factory').addEventListener('click',async()=>{const expA=Object.keys(webllm||{});const expB=Object.keys(webllm?.default||{});logDiag({exports_module:expA,exports_default:expB});try{await ensureEngine();assertOk('Engine initialized',!!engine,selectedModel)}catch(e){assertOk('Engine initialized',false,String(e))}})
    $('btn-test-generate').addEventListener('click',async(e)=>{const out=await callLocalLLM('Kembalikan JSON murni {"ok":true,"source":"local"}',e.target);const parsed=extractJson(out||'');assertOk('Local returned text',!!out);assertOk('Parsable JSON',!!parsed);if(parsed)logDiag(parsed)})
    $('btn-test-or-text').addEventListener('click',async(e)=>{provider='openrouter';const out=await callOpenRouterText('Kembalikan JSON murni {"ok":true,"source":"openrouter"}',e.target);const parsed=extractJson(out||'');assertOk('OR text returned',!!out);assertOk('Parsable JSON',!!parsed)})
    $('btn-test-or-img').addEventListener('click',async(e)=>{provider='openrouter';const url=await callOpenRouterImage('a minimal icon of a cat, vector',e.target);assertOk('OR image url/b64',!!url, url?url.slice(0,48)+'…':'')})

    // Init
    (function init(){const seed=Math.floor(Math.random()*100000);$('continuity-seed').value=seed;try{appConfig=webllm.prebuiltAppConfig||webllm?.default?.prebuiltAppConfig;if(appConfig)populateModelSelector()}catch{}})();
  </script>
</body>
</html>
